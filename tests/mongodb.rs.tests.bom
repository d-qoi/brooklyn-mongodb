brooklyn.catalog:
  version: "1.0"
  iconUrl: https://webassets.mongodb.com/_com_assets/cms/mongodb-logo-rgb-j6w271g1xn.jpg
  license_code: Apache-2.0

  items:
    - id: mongodb-rs-basic-manipulation
      item:
        type: org.apache.brooklyn.test.framework.TestCase
        brooklyn.config:
          target: $brooklyn:component("mongodb-server")

          SHELL.env:
            NODELIST: $brooklyn:component("my-mongodb-replicaset").attributeWhenReady("mongodb.rs.address.list")

        brooklyn.children:
          - name: 01. Assert Running
            type: assert-running 
            brooklyn.config:
              timeout: 1h

          - name: 02. Create item
            type: ssh-test-succeeds
            brooklyn.config:
              timeout: 1h 
              command: |
                # connect to any and pull the primary
                OTHERNODEADDRESS=$(echo $NODELIST | awk '{print $1}')
                PRIMARYNODEADDRESS=$(mongo --host $OTHERNODEADDRESS --eval "db.runCommand( { isMaster : 1 } ) ['primary']" | sed '3!d')
                # create an item on the primary
                # connect to another that is not the primary
                # enable searching on secondary nodes
                # check for the item created on the primary

          - name: 03. check fail over
            type: ssh-test-succeeds
            brooklyn.config:
              timeout: 1h
              command: |
                # connect to the any node and pull the primary
                OTHERNODEADDRESS=$(echo $NODELIST | awk '{print $1}')
                PRIMARYNODEADDRESS=$(mongo --host $OTHERNODEADDRESS --eval "db.runCommand( { isMaster : 1 } ) ['primary']" | sed '3!d')
                # somehow kill the mongod process of the primary node, not just stopping it with service
                # check to make sure that the primary node has changed to one of the secondaries
                # restart the killed mongod 